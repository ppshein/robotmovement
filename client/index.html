<!DOCTYPE html>
<html lang="en">
	<head>
		<title>ROBOT MOVEMENT</title>
		<meta charset="utf-8">
		<meta name="generator" content="Pwa">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="./css/main.css" />
    </head>

    <body ng-app="robotApp" ng-controller="homeCtrl" ng-keydown="keyDown($event)">
        <div>
            <table class="mainTable" border="0">
                <tr>
                    <td>
                        <table width="50%" border="0" class="card movementTable">
                            <tr ng-repeat="y in botMovement.movementSpace.y">
                                <td ng-repeat="x in botMovement.movementSpace.x" class="block">
                                    <span ng-show="x === botMovement.movementSpace.direction.x && y === botMovement.movementSpace.direction.y">
                                        <img src="./images/cute-cartoon-robot-head.png" ng-style="imageRotate">
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table width="50%" border="0" class="movementTable">
                            <tr>
                                <td>
                                    X: {{ movement.x }} - Y: {{ movement.y }} - Report: {{ movement.f }}
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td class="information">
                        To move Robot, use left, right, top and bottom arrow keys of keyboard. To rotate Robot, use L to left and R to right.
                    </td>
                </tr>
            </table>
        </div>
        <script src="/bower_components/angular/angular.min.js"></script>
        <script src="./scripts/app.js"></script>
        <script>
            var robotApp = angular.module('robotApp');
            robotApp.controller('homeCtrl', function ($scope, $rootScope, $httpParamSerializer) {
                /* init location */
                $scope.movement = {
                    x: 0,
                    y: 0,
                    f: '',
                    d: 'move'
                };
                $scope.imageRotate = {'transform': 'rotate(0deg)'};
                
                function moveRobot(axis) {
                    fetch('https://5sb06hqgnf.execute-api.ap-southeast-1.amazonaws.com/prod?' + $httpParamSerializer(axis)).then((response) => {
                        return response.json();
                    }).then(function (response) {
                        $scope.movement.x = response.message.x;
                        $scope.movement.y = response.message.y;
                        $scope.movement.f = response.message.f !== 0 ? response.message.f : 'north';
                        $rootScope.botMovement.movementSpace.direction = response.message;
                        if (response.message.d !== 'move') {
                            $scope.imageRotate = {'transform': 'rotate(' + imageRotation($scope.movement.f)[0].degree + 'deg)'};
                        }
                        $scope.$apply();
                    }).catch((err) => {
                        console.log('err ' + err);
                    });
                }

                function moveDirection(keyCode) {
                    return result = $rootScope.botMovement.movementKey.filter(
                        function(item) {
                            return item[keyCode]
                        }
                    );
                }

                function imageRotation(direction) {
                    return result = $rootScope.botMovement.degrees.filter(
                        function(item) {
                            return item.direction === direction
                        }
                    );
                }

                function allowKey(keyCode) {
                    return $rootScope.botMovement.allowKeyCode.indexOf(keyCode);
                }

                $scope.keyDown = function(value) {
                    if (allowKey(value.keyCode) > -1) {
                        $scope.movement.f = moveDirection(value.keyCode)[0][value.keyCode] !== ' ' ? moveDirection(value.keyCode)[0][value.keyCode] : ($scope.movement.f !== '' ? $scope.movement.f : 'north');
                        $scope.movement.d = moveDirection(value.keyCode)[0]['d'];
                        moveRobot($scope.movement);
                    }
                };

                moveRobot($scope.movement);

            });
        </script>
    </body>
</html>