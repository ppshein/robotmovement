<!DOCTYPE html>
<html lang="en">
	<head>
		<title>ROBOT MOVEMENT</title>
		<meta charset="utf-8">
		<meta name="generator" content="Pwa">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="./css/main.css" />
    </head>

    <body ng-app="robotApp" ng-controller="homeCtrl" ng-keydown="keyDown($event)">
        <div>
            <table class="mainTable" border="0">
                <tr>
                    <td>
                        <table width="50%" border="1" class="movementTable">
                            <tr ng-repeat="y in movementSpace.y">
                                <td ng-repeat="x in movementSpace.x" class="block">
                                    <span ng-show="x === movementSpace.direction.x && y === movementSpace.direction.y">
                                        <img src="./images/cute-cartoon-robot-head.png">
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td>
                        <table width="50%" border="1" class="movementTable">
                            <tr>
                                <td>
                                    X: {{ movement.x }} - Y: {{ movement.y }} - Report: {{ movement.f }}
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td class="information">
                        To move Robot, use left, right, top and bottom arrow keys of keyboard. To rotate Robot, use L to left and R to right.
                    </td>
                </tr>
            </table>
        </div>
        <script src="/bower_components/angular/angular.min.js"></script>
        <script src="./app.js"></script>
        <script>
            var robotApp = angular.module('robotApp');
            robotApp.controller('homeCtrl', function ($scope, $rootScope, $httpParamSerializer) {
                /* init location */
                $scope.movement = {
                    x: 0,
                    y: 0,
                    f: '',
                    d: 'move'
                };
                
                function moveRobot(axis) {
                    fetch('http://localhost:5000/?' + $httpParamSerializer(axis)).then((response) => {
                        return response.json();
                    }).then(function (response) {
                        $scope.movement.x = response.x;
                        $scope.movement.y = response.y;
                        $scope.movementSpace.direction = response;
                        $scope.$apply();
                    }).catch((err) => {
                        console.log('err ' + err);
                    });
                }

                function moveDirection(keyCode) {
                    return result = $rootScope.movementKey.filter(
                        function(item) {
                            return item[keyCode]
                        }
                    );
                }

                function toDegrees (angle) {
                    return angle * (180 / Math.PI);
                }   
                
                function toRadians (angle) {
                    return angle * (Math.PI / 180);
                }

                function calculateAngle(x1, y1, x2, y2) {
                    var angle = toDegrees(Math.atan2(x2 - x1, y2 - y1));
                    angle = angle + Math.ceil( - angle / 360 ) * 360;
                    return angle;
                }

                function angle(cx, cy, ex, ey) {
                    var dy = ey - cy;
                    var dx = ex - cx;
                    var theta = Math.atan2(dy, dx);
                    theta *= 180 / Math.PI;
                    return theta;
                }

                function angle360(cx, cy, ex, ey) {
                    var theta = angle(cx, cy, ex, ey);
                    if (theta < 0) theta = 360 + theta;
                    return theta;
                }

                console.log(angle(2, 2, 2, 1));
                console.log(angle360(2, 2, 2, 1));

                function allowKey(keyCode) {
                    return $rootScope.allowKeyCode.indexOf(keyCode);
                }

                $scope.keyDown = function(value) {
                    if (allowKey(value.keyCode) > -1) {
                        $scope.movement.f = moveDirection(value.keyCode)[0][value.keyCode];
                        $scope.movement.d = moveDirection(value.keyCode)[0]['d'];
                        moveRobot($scope.movement);
                    }
                };

                moveRobot($scope.movement);

            });
        </script>
    </body>
</html>